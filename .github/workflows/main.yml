name: Build and deploy MeetTrack server

on:
  push:
    branches: [ci]

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: steelkiwi/ansible:5.10.0
    steps:
      - uses: actions/checkout@v4
        name: Checkout üõéÔ∏è

      - name: Run ansible
        env:
          repo: ${{ github.repository }}
          domain_name: ${{ secrets[format('DOMAIN_NAME_{0}', env.REPO_BRANCH)] }}
          server: ${{ secrets[format('DOMAIN_NAME_{0}', env.REPO_BRANCH)] }}
          ssh_key: ${{ secrets[format('SSH_KEY_{0}', env.REPO_BRANCH)] }}
          jump_host: ${{ secrets[format('JUMP_HOST_{0}', env.REPO_BRANCH)] }}
          migration_host: ${{ secrets[format('MIGRATION_HOST_{0}', env.REPO_BRANCH)] }}
        run: |
          eval $(ssh-agent -s)
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' | ssh-add - 
          git config --global user.name "$GITHUB_ACTOR"
          export ANSIBLE_CONFIG=$(eval echo `readlink -f ansible/ansible.cfg`)
          cd ansible && ansible-playbook deploy.yml --extra-vars="image=meettrack |
                                                                           tag=latest
                                                                           branch=ci
                                                                           repo=${{ env.repo }}
                                                                           playbook=$GITHUB_REF_NAME.yml
                                                                           project_name=meettrack
                                                                           
